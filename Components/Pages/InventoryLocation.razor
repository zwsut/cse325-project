@page "/inventory/{Location}"
@using cse325_project.Models.Database
@using cse325_project.Services
@using System.Security.Claims
@inject ISupabaseService SupabaseService
@inject IUserContextService UserContextService
@inject AuthenticationStateProvider AuthStateProvider


<PageTitle>@Title</PageTitle>

<div class="location-head">
    <h1>@Title</h1>
    <a class="btn-add" href="/items/new">Add Item</a>
</div>

@if (_loading)
{
    <p>Loading items...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <p class="simple-muted">Error: @_error</p>
}


<div class="table-wrap">
    <table class="inv-table">
        <thead>
            <tr>
                <th class="col-id">ID</th>
                <th>Item Name</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Description</th>
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Items)
            {
                <tr>
                    <td class="id">@item.Id</td>
                    <td>@item.Name</td>
                    <td>@item.Amount</td>
                    <td>@item.Category</td>
                    <td class="desc">@item.Description</td>
                    <td class="actions">
                        <button class="icon-btn" type="button" title="Edit" aria-label="Edit" @onclick="() => StartEdit(item)">âœŽ</button>
                        <button class="icon-btn danger" type="button" title="Delete" aria-label="Delete">ðŸ—‘</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Editing is not null)
{
    <div class="overlay" @onclick="CloseEdit"></div>
    <aside class="edit-panel" role="dialog" aria-label="Edit Inventory Item">
        <div class="edit-header">Edit Inventory Item</div>
        <div class="edit-body">
            <h2 class="edit-title">@Editing.Name</h2>
            <div class="tags">
                <span class="tag">@Editing.Category</span>
                <span class="tag muted">Add Tag</span>
            </div>

            <div class="block">
                <div class="block-title">Product Details:</div>
                <div class="kv"><span>Brand:</span> <em>Optional</em></div>
                <div class="kv"><span>UPC:</span> <em>Optional</em></div>
            </div>

            <div class="block">
                <div class="block-title">Inventory:</div>
                <div class="kv"><span>Total:</span> 1.5 Loafs (36 slices)</div>
                <div class="kv"><span>Kitchen:</span> 12 slices / 24 slices</div>
                <div class="kv"><span>Garage:</span> 24 slices / 24 slices</div>
                <div class="kv"><span>Trigger Amount:</span> .25 Loafs (6 slices)</div>
                <div class="kv"><span>Desired Total:</span> 3 Loafs (72 slices)</div>
            </div>
        </div>

        <div class="edit-actions">
            <button class="btn-save" type="button" @onclick="CloseEdit">Save</button>
            <button class="btn-cancel" type="button" @onclick="CloseEdit">Cancel</button>
        </div>
    </aside>
}

@code {
    [Parameter] public string? Location { get; set; }

    private InventoryDisplayItem? Editing;

    private string _title = "Inventory";
    private bool _loading = true;
    private string? _error;

    private List<InventoryDisplayItem> _items = new();

    private string Title => _title;
    private IReadOnlyList<InventoryDisplayItem> Items => _items;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;
        _items = new();

        try
        {
            await SupabaseService.InitializeAsync();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            var email = authState.User.FindFirst(ClaimTypes.Email)?.Value;

            var (user, group) = await UserContextService.GetForClaimsAsync(userIdClaim, email);
            if (user is null || group is null)
            {
                _error = "You must be logged in.";
                return;
            }

            // 1) Load pantries for this user's group
            var pantryRes = await SupabaseService.Client
                .From<Pantry>()
                .Where(p => p.GroupId == group.GroupId)
                .Get();

            var pantries = pantryRes.Models ?? new List<Pantry>();
            if (pantries.Count == 0)
            {
                _title = "Inventory";
                _items = new();
                return;
            }

            // 2) Load all locations for those pantries
            var pantryIds = pantries.Select(p => p.PantryId).ToList();

            // Supabase typed client doesn't do IN() super nicely in all versions,
            // so we query per pantry (same pattern you already use in your sidebar).
            PantryLocation? matchedLocation = null;
            Pantry? matchedPantry = null;

            foreach (var pantry in pantries)
            {
                var locRes = await SupabaseService.Client
                    .From<PantryLocation>()
                    .Where(l => l.PantryId == pantry.PantryId)
                    .Get();

                var locations = locRes.Models ?? new List<PantryLocation>();
                matchedLocation = locations.FirstOrDefault(l => ToSlug(l.Name) == (Location ?? "").ToLowerInvariant());
                if (matchedLocation is not null)
                {
                    matchedPantry = pantry;
                    break;
                }
            }

            if (matchedLocation is null || matchedPantry is null)
            {
                _title = ToTitle(Location);
                _items = new();
                return;
            }

            _title = $"{matchedPantry.Name} / {matchedLocation.Name}";

            // 3) Query inventory items for this location
            var invRes = await SupabaseService.Client
                .From<InventoryItem>()
                .Where(i => i.LocationId == matchedLocation.LocationId)
                .Get();

            var invItems = invRes.Models ?? new List<InventoryItem>();

            // 4) Pull catalog for any item_id we have (so we can show names)
            var itemIds = invItems
                .Where(i => i.ItemId.HasValue)
                .Select(i => i.ItemId!.Value)
                .Distinct()
                .ToList();

            var catalogMap = new Dictionary<Guid, CatalogItem>();
            if (itemIds.Count > 0)
            {
                // simplest: fetch whole catalog then map (fine for small projects)
                var catRes = await SupabaseService.Client.From<CatalogItem>().Get();
                var cat = catRes.Models ?? new List<CatalogItem>();
                catalogMap = cat.Where(c => itemIds.Contains(c.ItemId))
                                .ToDictionary(c => c.ItemId, c => c);
            }

            // 5) Map to your display model
            _items = invItems
                .OrderBy(i => i.CreatedAt)
                .Select(i =>
                {
                    var name =
                        i.CustomName ??
                        (i.ItemId.HasValue && catalogMap.TryGetValue(i.ItemId.Value, out var c)
                            ? (string.IsNullOrWhiteSpace(c.Brand) ? c.Name : $"{c.Name} ({c.Brand})")
                            : "Unnamed");

                    var amount = $"{i.Quantity} {i.Unit}".Trim();

                    return new InventoryDisplayItem(
                        i.InventoryId.ToString()[..8],  // short id for UI
                        name,
                        amount,
                        "", // category later
                        i.Notes ?? ""
                    );
                })
                .ToList();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void StartEdit(InventoryDisplayItem item) => Editing = item;
    private void CloseEdit() => Editing = null;

    private static string ToTitle(string? location)
    {
        if (string.IsNullOrWhiteSpace(location)) return "Inventory";
        return location
            .Replace('-', ' ')
            .Split(' ', StringSplitOptions.RemoveEmptyEntries)
            .Select(w => char.ToUpperInvariant(w[0]) + w[1..])
            .Aggregate((a, b) => $"{a} {b}");
    }

    private static string ToSlug(string? value)
    {
        if (string.IsNullOrWhiteSpace(value)) return "inventory";

        var chars = value.Trim().ToLowerInvariant()
            .Select(c => char.IsLetterOrDigit(c) ? c : '-')
            .ToArray();

        var normalized = new string(chars);
        while (normalized.Contains("--"))
            normalized = normalized.Replace("--", "-");

        var slug = normalized.Trim('-');
        return string.IsNullOrWhiteSpace(slug) ? "inventory" : slug;
    }
}

