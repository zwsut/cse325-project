@page "/signup"
@using Microsoft.AspNetCore.Components.Authorization
@layout LoginLayout
@inject NavigationManager Navigation
@attribute [AllowAnonymous]
@rendermode InteractiveServer

<PageTitle>Sign Up</PageTitle>

<div class="signup-container">
    <div class="signup-shell">
        <div class="welcome-panel">
            <div class="welcome-visual" aria-hidden="true">
                <svg class="welcome-illustration" viewBox="0 0 220 200" role="img">
                    <defs>
                        <linearGradient id="kitGrad" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#a7f3d0" />
                            <stop offset="100%" stop-color="#22c55e" />
                        </linearGradient>
                    </defs>
                    <rect x="10" y="20" width="200" height="140" rx="18" fill="rgba(255,255,255,0.15)" />
                    <rect x="30" y="40" width="160" height="20" rx="10" fill="url(#kitGrad)" />
                    <rect x="30" y="70" width="120" height="16" rx="8" fill="rgba(255,255,255,0.6)" />
                    <rect x="30" y="95" width="140" height="14" rx="7" fill="rgba(255,255,255,0.45)" />
                    <rect x="30" y="118" width="90" height="12" rx="6" fill="rgba(255,255,255,0.35)" />
                    <circle cx="170" cy="115" r="24" fill="url(#kitGrad)" opacity="0.9" />
                </svg>
            </div>
            <h1 class="welcome-title">Create your KITS account</h1>
            <p class="welcome-subtitle">Kitchen Inventory Tracking System</p>
            <p class="welcome-tagline">Set up your family or household inventory in minutes.</p>
        </div>

        <div class="signup-card">
            <div class="signup-header">
                <h2>Create Account</h2>
                <p>Join KITS to start tracking your kitchen inventory</p>
            </div>

            <form method="post" action="/auth/signup" class="signup-form" novalidate>
                <AntiforgeryToken />
                <input type="hidden" name="returnUrl" value="@_returnUrl" />

                <div class="form-row">
                    <div class="form-group">
                        <div class="input-wrapper">
                            <input id="firstName" name="firstName" type="text" required @bind="_model.FirstName" />
                            <label for="firstName">First Name</label>
                            <span class="focus-border"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input id="lastName" name="lastName" type="text" required @bind="_model.LastName" />
                            <label for="lastName">Last Name</label>
                            <span class="focus-border"></span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <input id="email" name="email" type="email" required autocomplete="email" @bind="_model.Email" />
                        <label for="email">Email Address</label>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper password-wrapper">
                        @if (passwordVisible)
                        {
                            <input id="password" name="password" type="text" required autocomplete="new-password" @bind="_model.Password" @key="passwordVisible" />
                        }
                        else
                        {
                            <input id="password" name="password" type="password" required autocomplete="new-password" @bind="_model.Password" @key="passwordVisible" />
                        }
                        <label for="password">Password</label>
                        <button type="button" class="password-toggle" aria-label="Toggle password visibility" @onclick="TogglePassword" @onclick:preventDefault="true">
                            <span class="eye-icon @(passwordVisible ? "show-password" : "")"></span>
                        </button>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper password-wrapper">
                        @if (confirmVisible)
                        {
                            <input id="confirmPassword" name="confirmPassword" type="text" required autocomplete="new-password" @bind="_model.ConfirmPassword" @key="confirmVisible" />
                        }
                        else
                        {
                            <input id="confirmPassword" name="confirmPassword" type="password" required autocomplete="new-password" @bind="_model.ConfirmPassword" @key="confirmVisible" />
                        }
                        <label for="confirmPassword">Confirm Password</label>
                        <button type="button" class="password-toggle" aria-label="Toggle password visibility" @onclick="ToggleConfirm" @onclick:preventDefault="true">
                            <span class="eye-icon @(confirmVisible ? "show-password" : "")"></span>
                        </button>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <button type="submit" class="signup-btn btn">
                    <span class="btn-text">Create Account</span>
                    <span class="btn-loader"></span>
                </button>
            </form>

            <div class="signup-link">
                <p>Already have an account? <a href="/login">Sign in</a></p>
            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="form-error">@errorMessage</div>
            }
        </div>
    </div>
</div>

@code {
    private readonly SignupModel _model = new();
    private bool passwordVisible;
    private bool confirmVisible;
    private string? errorMessage;
    private string _returnUrl = "/";

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        var returnUrl = query.Get("returnUrl");
        if (!string.IsNullOrWhiteSpace(returnUrl) && Uri.TryCreate(returnUrl, UriKind.Relative, out _))
        {
            _returnUrl = returnUrl;
        }

        var error = query.Get("error");
        errorMessage = error switch
        {
            "missing" => "Please fill in all required fields.",
            "password" => "Passwords must match and be at least 6 characters.",
            "exists" => "An account with this email already exists. Try signing in.",
            "invalid" => "That email address is invalid.",
            "confirm" => "Account created but email confirmation is required before sign in.",
            "household" => "Account created, but we could not finish setting up your household. Please try again.",
            "rate" => "Too many attempts. Please wait and try again.",
            "unknown" => "We could not create your account. Please try again.",
            _ => null
        };
    }

    private void TogglePassword() => passwordVisible = !passwordVisible;
    private void ToggleConfirm() => confirmVisible = !confirmVisible;
}
