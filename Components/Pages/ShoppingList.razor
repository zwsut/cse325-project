@page "/shopping-list"
@using System.Security.Claims
@using cse325_project.Models.Database
@using cse325_project.Services
@inject ISupabaseService SupabaseService
@inject IUserContextService UserContextService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Shopping List</PageTitle>

<h1 class="simple-title">Shopping List</h1>
<p class="simple-muted">View your list, check items off, edit quantities, and remove items.</p>

@if (_loading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <p class="simple-muted">Error: @_error</p>
}
else if (_list is null || _currentUser is null || _currentGroup is null)
{
    <p class="simple-muted">You must be logged in.</p>
}
else
{
    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <div class="form-message">@_message</div>
    }

    <div class="table-wrap">
        <table class="inv-table">
            <thead>
                <tr>
                    <th style="width: 70px;">Done</th>
                    <th>Item</th>
                    <th style="width: 140px;">Qty</th>
                    <th style="width: 140px;">Unit</th>
                    <th class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (_items.Count == 0)
                {
                    <tr>
                        <td colspan="5" class="desc">No items yet.</td>
                    </tr>
                }
                else
                {
                    @foreach (var row in _items)
                    {
                        <tr>
                            <td>
                                <input type="checkbox"
                                       checked="@row.IsChecked"
                                       @onchange="async _ => await ToggleCheckedAsync(row)"
                                       disabled="@_busy" />
                            </td>

                            <td>@GetRowName(row)</td>

                            <td>
                                <input class="input" style="max-width:120px;"
                                    type="number" step="0.0001" min="0"
                                    value="@GetEditQty(row.ListItemId)"
                                    @onchange="e => SetEditQty(row.ListItemId, e.Value)"
                                    disabled="@_busy" />
                            </td>

                            <td>
                                <input class="input" style="max-width:120px;"
                                    type="text"
                                    value="@GetEditUnit(row.ListItemId)"
                                    @onchange="e => SetEditUnit(row.ListItemId, e.Value)"
                                    disabled="@_busy" />
                            </td>


                            <td class="actions">
                                <button class="icon-btn"
                                        type="button"
                                        title="Save"
                                        aria-label="Save"
                                        @onclick="() => SaveRowAsync(row)"
                                        disabled="@_busy">ðŸ’¾</button>

                                <button class="icon-btn danger"
                                        type="button"
                                        title="Delete"
                                        aria-label="Delete"
                                        @onclick="() => DeleteAsync(row)"
                                        disabled="@_busy">ðŸ—‘</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

@code {
    private bool _loading = true;
    private bool _busy;
    private string? _error;
    private string? _message;

    private AppUser? _currentUser;
    private Group? _currentGroup;
    private AppList? _list;

    private List<AppListItem> _items = new();
    private List<CatalogItem> _catalog = new();
    private Dictionary<Guid, CatalogItem> _catalogMap = new();

    // Inline edit buffers
    private readonly Dictionary<Guid, decimal> _editQty = new();
    private readonly Dictionary<Guid, string?> _editUnit = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await SupabaseService.InitializeAsync();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            var email = authState.User.FindFirst(ClaimTypes.Email)?.Value;

            (_currentUser, _currentGroup) = await UserContextService.GetForClaimsAsync(userIdClaim, email);
            if (_currentUser is null || _currentGroup is null)
            {
                _error = "You must be logged in.";
                return;
            }

            await LoadCatalogAsync();
            _list = await GetOrCreateShoppingListAsync(_currentGroup.GroupId, _currentUser.UserId);
            await RefreshItemsAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadCatalogAsync()
    {
        var res = await SupabaseService.Client.From<CatalogItem>().Get();
        _catalog = (res.Models ?? new List<CatalogItem>()).OrderBy(c => c.Name).ToList();
        _catalogMap = _catalog.ToDictionary(c => c.ItemId, c => c);
    }

    private async Task<AppList> GetOrCreateShoppingListAsync(Guid groupId, Guid userId)
    {
        var res = await SupabaseService.Client
            .From<AppList>()
            .Where(l => l.GroupId == groupId)
            .Get();

        var existing = (res.Models ?? new List<AppList>())
            .FirstOrDefault(l => string.Equals(l.ListType, "shopping", StringComparison.OrdinalIgnoreCase)
                              && l.ArchivedAt == null);

        if (existing is not null) return existing;

        var inserted = await SupabaseService.Client
            .From<AppList>()
            .Insert(new AppList
            {
                ListId = Guid.NewGuid(),
                GroupId = groupId,
                Name = "Shopping List",
                ListType = "shopping",
                CreatedByUser = userId,
                CreatedAt = DateTime.UtcNow,
                ArchivedAt = null
            });

        return inserted.Models.First();
    }

    private async Task RefreshItemsAsync()
    {
        if (_list is null) return;

        var res = await SupabaseService.Client
            .From<AppListItem>()
            .Where(i => i.ListId == _list.ListId)
            .Get();

        _items = (res.Models ?? new List<AppListItem>())
            .OrderBy(i => i.IsChecked)
            .ThenBy(i => i.CustomName ?? "")
            .ThenBy(i => i.CreatedAt)
            .ToList();

        // Seed edit buffers
        _editQty.Clear();
        _editUnit.Clear();
        foreach (var item in _items)
        {
            _editQty[item.ListItemId] = item.Quantity;
            _editUnit[item.ListItemId] = item.Unit;
        }
    }

    private async Task ToggleCheckedAsync(AppListItem row)
    {
        if (_busy) return;
        _busy = true;
        _message = null;

        try
        {
            row.IsChecked = !row.IsChecked;
            await SupabaseService.Client.From<AppListItem>().Update(row);
            await RefreshItemsAsync();
        }
        catch (Exception ex)
        {
            _message = $"Error updating item: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task SaveRowAsync(AppListItem row)
    {
        if (_busy) return;
        _busy = true;
        _message = null;

        try
        {
            if (!_editQty.TryGetValue(row.ListItemId, out var qty) || qty <= 0)
                qty = 1;

            _editUnit.TryGetValue(row.ListItemId, out var unit);
            unit = string.IsNullOrWhiteSpace(unit) ? null : unit.Trim();

            row.Quantity = qty;
            row.Unit = unit;

            await SupabaseService.Client.From<AppListItem>().Update(row);

            _message = "Saved.";
            await RefreshItemsAsync();
        }
        catch (Exception ex)
        {
            _message = $"Error saving: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task DeleteAsync(AppListItem row)
    {
        if (_busy) return;
        _busy = true;
        _message = null;

        try
        {
            await SupabaseService.Client
                .From<AppListItem>()
                .Where(i => i.ListItemId == row.ListItemId)
                .Delete();

            _message = "Removed.";
            await RefreshItemsAsync();
        }
        catch (Exception ex)
        {
            _message = $"Error deleting item: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private string GetRowName(AppListItem row)
    {
        if (row.ItemId.HasValue && _catalogMap.TryGetValue(row.ItemId.Value, out var c))
            return FormatCatalog(c);

        return row.CustomName ?? "Unnamed";
    }

    private static string FormatCatalog(CatalogItem c)
        => string.IsNullOrWhiteSpace(c.Brand) ? c.Name : $"{c.Name} ({c.Brand})";

    private string GetEditQty(Guid id)
    {
        return _editQty.TryGetValue(id, out var v) ? v.ToString() : "1";
    }

    private void SetEditQty(Guid id, object? value)
    {
        // value comes in as string from the browser
        var s = value?.ToString();
        if (decimal.TryParse(s, out var d))
            _editQty[id] = d;
        else
            _editQty[id] = 1;
    }

    private string GetEditUnit(Guid id)
    {
        return _editUnit.TryGetValue(id, out var v) ? (v ?? "") : "";
    }

    private void SetEditUnit(Guid id, object? value)
    {
        _editUnit[id] = value?.ToString();
    }
}


