@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@layout LoginLayout
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@attribute [AllowAnonymous]

<div class="login-container">
    <div class="login-shell">
        <div class="welcome-panel">
            <div class="welcome-visual" aria-hidden="true">
                <svg class="welcome-illustration" viewBox="0 0 220 200" role="img">
                    <defs>
                        <linearGradient id="kitGrad" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#a7f3d0" />
                            <stop offset="100%" stop-color="#22c55e" />
                        </linearGradient>
                    </defs>
                    <rect x="10" y="20" width="200" height="140" rx="18" fill="rgba(255,255,255,0.15)" />
                    <rect x="30" y="40" width="160" height="20" rx="10" fill="url(#kitGrad)" />
                    <rect x="30" y="70" width="120" height="16" rx="8" fill="rgba(255,255,255,0.6)" />
                    <rect x="30" y="95" width="140" height="14" rx="7" fill="rgba(255,255,255,0.45)" />
                    <rect x="30" y="118" width="90" height="12" rx="6" fill="rgba(255,255,255,0.35)" />
                    <circle cx="170" cy="115" r="24" fill="url(#kitGrad)" opacity="0.9" />
                </svg>
            </div>
            <h1 class="welcome-title">Welcome to KITS</h1>
            <p class="welcome-subtitle">Kitchen Inventory Tracking System</p>
            <p class="welcome-tagline">Sign in to keep your kitchen organized and up to date.</p>
        </div>

        <div class="login-card">
            <div class="login-header">
                <h2>Sign In</h2>
                <p>Access your inventory dashboard</p>
            </div>

            <EditForm EditContext="_editContext" OnSubmit="HandleSubmitAsync" class="login-form" novalidate>
                <div class="form-group @(HasError(nameof(LoginModel.Email)) ? "error" : "")">
                    <div class="input-wrapper">
                        <input id="email"
                               name="email"
                               type="email"
                               required
                               autocomplete="email"
                               @bind="_model.Email" />
                        <label for="email">Email Address</label>
                        <span class="focus-border"></span>
                    </div>
                    <span class="error-message @(HasError(nameof(LoginModel.Email)) ? "show" : "")">
                        @GetError(nameof(LoginModel.Email))
                    </span>
                </div>

                <div class="form-group @(HasError(nameof(LoginModel.Password)) ? "error" : "")">
                    <div class="input-wrapper password-wrapper">
                        @if (passwordVisible)
                        {
                            <input id="password"
                                   name="password"
                                   type="text"
                                   required
                                   autocomplete="current-password"
                                   @bind="_model.Password"
                                   @key="passwordVisible" />
                        }
                        else
                        {
                            <input id="password"
                                   name="password"
                                   type="password"
                                   required
                                   autocomplete="current-password"
                                   @bind="_model.Password"
                                   @key="passwordVisible" />
                        }
                        <label for="password">Password</label>
                        <button type="button"
                                class="password-toggle"
                                aria-label="Toggle password visibility"
                                @onclick="TogglePassword"
                                @onclick:preventDefault="true">
                            <span class="eye-icon @(passwordVisible ? "show-password" : "")"></span>
                        </button>
                        <span class="focus-border"></span>
                    </div>
                    <span class="error-message @(HasError(nameof(LoginModel.Password)) ? "show" : "")">
                        @GetError(nameof(LoginModel.Password))
                    </span>
                </div>

                <div class="form-options">
                    <label class="remember-wrapper">
                        <input id="remember" name="remember" type="checkbox" @bind="_model.RememberMe" />
                        <span class="checkbox-label">
                            <span class="checkmark"></span>
                            Remember me
                        </span>
                    </label>
                    <a href="#" class="forgot-password" @onclick:preventDefault="true">Forgot password?</a>
                </div>

                <button type="submit" class="login-btn btn @(isSubmitting ? "loading" : "")" disabled="@isSubmitting">
                    <span class="btn-text">Sign In</span>
                    <span class="btn-loader"></span>
                </button>
            </EditForm>

            <div class="divider">
                <span>or continue with</span>
            </div>

            <div class="social-login">
                <button type="button" class="social-btn google-btn">
                    <span class="social-icon google-icon"></span>
                    Google
                </button>
                <button type="button" class="social-btn github-btn">
                    <span class="social-icon github-icon"></span>
                    GitHub
                </button>
            </div>

            <div class="signup-link">
                <p>Don't have an account? <a href="/signup">Sign up</a></p>
            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="form-error">@errorMessage</div>
            }
        </div>
    </div>
</div>

@code {
    private readonly LoginModel _model = new();
    private EditContext _editContext = default!;
    private readonly Dictionary<string, string> _errors = new();
    private bool isSubmitting;
    private string? errorMessage;
    private bool passwordVisible;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private void TogglePassword()
    {
        passwordVisible = !passwordVisible;
    }

    private async Task HandleSubmitAsync(EditContext context)
    {
        if (isSubmitting)
        {
            return;
        }

        _errors.Clear();
        errorMessage = null;

        if (!ValidateModel())
        {
            return;
        }

        if (AuthStateProvider is not SupabaseAuthStateProvider supabaseAuth)
        {
            errorMessage = "Auth provider is not configured.";
            return;
        }

        isSubmitting = true;
        try
        {
            await supabaseAuth.SignInAsync(_model.Email, _model.Password);
            var returnUrl = GetReturnUrl();
            Navigation.NavigateTo(returnUrl ?? "/");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private bool ValidateModel()
    {
        var validationResults = new List<ValidationResult>();
        var isValid = Validator.TryValidateObject(
            _model,
            new ValidationContext(_model),
            validationResults,
            validateAllProperties: true);

        foreach (var result in validationResults)
        {
            var memberName = result.MemberNames.FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(memberName))
            {
                _errors[memberName] = result.ErrorMessage ?? "Invalid value.";
            }
        }

        return isValid;
    }

    private bool HasError(string fieldName) => _errors.ContainsKey(fieldName);
    private string GetError(string fieldName) => _errors.TryGetValue(fieldName, out var msg) ? msg : string.Empty;

    private string? GetReturnUrl()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (string.IsNullOrWhiteSpace(uri.Query))
        {
            return null;
        }

        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var returnUrl = query.Get("returnUrl");
        if (string.IsNullOrWhiteSpace(returnUrl))
        {
            return null;
        }

        return Uri.TryCreate(returnUrl, UriKind.Relative, out _) ? returnUrl : null;
    }

    private sealed class LoginModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(6)]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }
}
