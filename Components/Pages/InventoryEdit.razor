@page "/inventory/edit"

<PageTitle>Edit Inventory</PageTitle>
<h1 class="simple-title">Edit Inventory Location</h1>
<p class="simple-muted">(Placeholder page) This can be your inventory location/category editor.</p>
@using System.ComponentModel.DataAnnotations
@using cse325_project.Services
@inject InventoryService InventoryService

<div class="form-wrap">
    <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        
        <div class="form-row">
            <label>Main Location</label>
            <InputSelect @bind-Value="Model.MainLocation" class="input">
                <option value="">-- Select --</option>
                @foreach (var ml in MainLocations)
                {
                    <option value="@ml">@ml</option>
                }
                <option value="__new__">Add new...</option>
            </InputSelect>
            <ValidationMessage For="() => Model.MainLocation" />
        </div>
        
        @if (Model.MainLocation == "__new__")
        {
            <div class="form-row">
                <label>New Main Location</label>
                <InputText @bind-Value="NewMainLocation" class="input" />
            </div>
        }

        <div class="form-row">
            <label>Sub Location</label>
            <InputText @bind-Value="Model.SubLocation" class="input" />
            <ValidationMessage For="() => Model.SubLocation" />
        </div>

        <div class="form-row">
            <label>Slug (url)</label>
            <InputText @bind-Value="Model.Slug" class="input" />
            <ValidationMessage For="() => Model.Slug" />
        </div>

        <div class="form-row">
            <label>Description</label>
            <InputTextArea @bind-Value="Model.Description" class="input" />
            <ValidationMessage For="() => Model.Description" />
        </div>

        <div class="form-actions">
            <button class="btn-save" type="submit">Save</button>
            <button class="btn-cancel" type="button" @onclick="Cancel">Cancel</button>
            <button class="btn-danger" type="button" @onclick="ConfirmDelete">Delete</button>
        </div>
    </EditForm>
    
    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="form-message">@Message</div>
    }
</div>

@if (Locations.Any())
{
    <h2>Current locations</h2>
    <table class="locations-table">
        <thead>
            <tr>
                <th>Main</th>
                <th>Sub</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var loc in Locations)
            {
                <tr>
                    <td>@loc.MainLocation</td>
                    <td>@loc.SubLocation</td>
                    <td>@loc.Description</td>
                    <td>
                        <button class="btn-link" @onclick="() => SelectForEdit(loc)">Edit</button>
                        <button class="btn-link-danger" @onclick="() => DeleteRow(loc)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private InventoryLocationDto Model { get; set; } = new InventoryLocationDto();
    private string? Message;
    private string NewMainLocation = string.Empty;
    private List<InventoryLocationDto> Locations = new();
    private IEnumerable<string> MainLocations => Locations
        .Select(l => l.MainLocation)
        .Where(s => !string.IsNullOrWhiteSpace(s) && s != "__new__")
        .Distinct()
        .OrderBy(s => s);

    protected override async Task OnInitializedAsync()
    {
        await RefreshLocations();
        if (Locations.Any())
        {
            Model = Locations.First();
        }
    }

    private async Task RefreshLocations()
    {
        Locations = (await InventoryService.GetLocationsAsync()).ToList();
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (Model.MainLocation == "__new__")
            {
                Model.MainLocation = NewMainLocation?.Trim() ?? string.Empty;
            }
            await InventoryService.SaveLocationAsync(Model);
            Message = "Saved successfully.";
            await RefreshLocations();
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
        }
    }

    private void Cancel()
    {
        Message = null;
    }

    private async Task ConfirmDelete()
    {
        if (string.IsNullOrEmpty(Model.Id)) return;
        await InventoryService.DeleteLocationAsync(Model.Id);
        Message = "Deleted.";
        Model = new InventoryLocationDto();
        await RefreshLocations();
    }

    private void SelectForEdit(InventoryLocationDto loc)
    {
        Model = new InventoryLocationDto
        {
            Id = loc.Id,
            MainLocation = loc.MainLocation,
            SubLocation = loc.SubLocation,
            Name = loc.Name,
            Slug = loc.Slug,
            Description = loc.Description
        };
        Message = null;
    }

    private async Task DeleteRow(InventoryLocationDto loc)
    {
        await InventoryService.DeleteLocationAsync(loc.Id);
        Message = "Deleted.";
        if (Model.Id == loc.Id)
        {
            Model = new InventoryLocationDto();
        }
        await RefreshLocations();
    }
}
