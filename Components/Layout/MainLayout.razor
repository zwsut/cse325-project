@inherits LayoutComponentBase
@implements IDisposable
@using System.Security.Claims
@using cse325_project.Services
@inject IUserContextService UserContextService
@inject IAppDataChangeService AppDataChangeService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<div class="app-shell @GetSidebarClassNames()">
    <aside class="sidebar">
        <Sidebar />
    </aside>
    <button class="sidebar-backdrop" type="button" aria-label="Close menu" @onclick="HideSidebar"></button>

    <div class="main">
        <header class="topbar">
            <div class="topbar-left">
                <button class="icon-btn" type="button" title="Menu" aria-label="Menu" aria-expanded="@_isSidebarVisible" @onclick="ToggleSidebar">
                    <span class="hamburger"></span>
                </button>
                <span class="topbar-title">@_groupName</span>
            </div>

            <div class="topbar-right">
                <span class="user-name">@_displayName</span>
                <div class="avatar" title="@_displayName" aria-label="@_displayName">@_avatarText</div>
                <form method="post" action="/auth/logout" class="logout-form">
                    <AntiforgeryToken />
                    <button type="submit" class="logout-btn">Log out</button>
                </form>
            </div>
        </header>

        <main class="app-content">
            @Body
        </main>
    </div>
</div>

@code {
    private string _groupName = "KITS";
    private string _displayName = "User";
    private string _avatarText = "U";
    private bool _isSidebarVisible = true;
    private bool _isSidebarInitialized;
    private const int MobileSidebarBreakpoint = 640;

    protected override async Task OnInitializedAsync()
    {
        AppDataChangeService.Changed += HandleDataChanged;
        await RefreshHeaderAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_isSidebarInitialized)
        {
            return;
        }

        try
        {
            var viewportWidth = await JSRuntime.InvokeAsync<int>("appLayout.getViewportWidth");
            _isSidebarVisible = viewportWidth > MobileSidebarBreakpoint;
            _isSidebarInitialized = true;
            StateHasChanged();
        }
        catch (InvalidOperationException)
        {
            // JS interop can fail during server prerender; retry next render.
        }
        catch (JSException)
        {
            _isSidebarInitialized = true;
        }
    }

    private async Task RefreshHeaderAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        var email = authState.User.FindFirst(ClaimTypes.Email)?.Value;

        try
        {
            var (user, group) = await UserContextService.GetForClaimsAsync(userIdClaim, email);
            _displayName = user.DisplayName ?? user.Email ?? _displayName;
            _avatarText = BuildInitials(_displayName);
            _groupName = group is null || string.IsNullOrWhiteSpace(group.Name)
                ? _displayName + "'s Household"
                : group.Name;
        }
        catch
        {
            if (!string.IsNullOrWhiteSpace(email))
            {
                _displayName = email;
                _avatarText = BuildInitials(_displayName);
            }

            _groupName = _displayName + "'s Household";
        }
    }

    private void ToggleSidebar()
    {
        _isSidebarVisible = !_isSidebarVisible;
    }

    private void HideSidebar()
    {
        _isSidebarVisible = false;
    }

    private string GetSidebarClassNames()
    {
        var stateClass = _isSidebarVisible ? "sidebar-visible" : "sidebar-hidden";
        var initClass = _isSidebarInitialized ? "sidebar-ready" : "sidebar-pending";
        return $"{stateClass} {initClass}";
    }

    private void HandleDataChanged(string scope)
    {
        if (scope != AppDataScopes.Profile && scope != AppDataScopes.Household)
        {
            return;
        }

        _ = InvokeAsync(async () =>
        {
            await RefreshHeaderAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        AppDataChangeService.Changed -= HandleDataChanged;
    }

    private static string BuildInitials(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "U";
        }

        var parts = value.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length == 1)
        {
            return parts[0].Length >= 2 ? parts[0].Substring(0, 2).ToUpperInvariant() : parts[0].ToUpperInvariant();
        }

        var first = parts[0][0];
        var last = parts[^1][0];
        return $"{char.ToUpperInvariant(first)}{char.ToUpperInvariant(last)}";
    }
}
