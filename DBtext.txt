db

-- =========================
-- Extensions
-- =========================
create extension if not exists pgcrypto;

-- =========================
-- USERS
-- =========================
create table if not exists users (
  user_id           uuid primary key default gen_random_uuid(),
  email             text unique not null,
  password_hash     text not null,
  display_name      text not null,
  created_at        timestamptz not null default now()
);

-- =========================
-- GROUPS
-- =========================
create table if not exists groups (
  group_id          uuid primary key default gen_random_uuid(),
  name              text not null,
  created_by_user   uuid not null references users(user_id),
  created_at        timestamptz not null default now()
);

-- =========================
-- GROUP MEMBERS
-- =========================
create table if not exists group_members (
  group_id          uuid not null references groups(group_id) on delete cascade,
  user_id           uuid not null references users(user_id) on delete cascade,
  role              text not null default 'member',
  joined_at         timestamptz not null default now(),
  primary key (group_id, user_id)
);

-- =========================
-- PANTRIES
-- =========================
create table if not exists pantries (
  pantry_id         uuid primary key default gen_random_uuid(),
  group_id          uuid not null references groups(group_id) on delete cascade,
  name              text not null,
  created_at        timestamptz not null default now()
);

-- =========================
-- PANTRY LOCATIONS
-- =========================
create table if not exists pantry_locations (
  location_id       uuid primary key default gen_random_uuid(),
  pantry_id         uuid not null references pantries(pantry_id) on delete cascade,
  name              text not null,
  notes             text,
  created_by_user   uuid references users(user_id),
  created_at        timestamptz not null default now(),
  unique (pantry_id, name)
);

-- =========================
-- ITEM CATEGORIES (scoped to group)
-- =========================
create table if not exists item_categories (
  category_id       uuid primary key default gen_random_uuid(),
  group_id          uuid not null references groups(group_id) on delete cascade,
  name              text not null,
  created_by_user   uuid references users(user_id),
  created_at        timestamptz not null default now(),
  unique (group_id, name)
);

-- =========================
-- ITEM CATALOG
-- =========================
create table if not exists item_catalog (
  item_id           uuid primary key default gen_random_uuid(),
  name              text not null,
  brand             text,
  description       text,
  default_unit      text,
  barcode           text,
  category_id       uuid references item_categories(category_id) on delete set null,
  unique (name, brand)
);

-- =========================
-- TAGS (scoped to group)
-- =========================
create table if not exists item_tags (
  tag_id            uuid primary key default gen_random_uuid(),
  group_id          uuid not null references groups(group_id) on delete cascade,
  name              text not null,
  created_by_user   uuid references users(user_id),
  created_at        timestamptz not null default now(),
  unique (group_id, name)
);

-- Many-to-many: item_catalog <-> tags
create table if not exists item_catalog_tags (
  item_id           uuid not null references item_catalog(item_id) on delete cascade,
  tag_id            uuid not null references item_tags(tag_id) on delete cascade,
  primary key (item_id, tag_id)
);

-- =========================
-- INVENTORY ITEMS
-- =========================
create table if not exists inventory_items (
  inventory_id      uuid primary key default gen_random_uuid(),
  pantry_id         uuid not null references pantries(pantry_id) on delete cascade,
  location_id       uuid references pantry_locations(location_id) on delete set null,

  item_id           uuid references item_catalog(item_id),
  custom_name       text,

  quantity          numeric(12, 3) not null default 0,
  unit              text not null,

  expires_on        date,
  notes             text,

  created_by_user   uuid references users(user_id),
  created_at        timestamptz not null default now(),
  updated_at        timestamptz not null default now(),

  check (
    (item_id is not null and custom_name is null)
    or
    (item_id is null and custom_name is not null)
  )
);

-- =========================
-- LISTS
-- =========================
create table if not exists lists (
  list_id           uuid primary key default gen_random_uuid(),
  group_id          uuid not null references groups(group_id) on delete cascade,
  name              text not null,
  list_type         text not null default 'shopping',
  created_by_user   uuid not null references users(user_id),
  created_at        timestamptz not null default now(),
  archived_at       timestamptz
);

-- =========================
-- LIST ITEMS
-- =========================
create table if not exists list_items (
  list_item_id      uuid primary key default gen_random_uuid(),
  list_id           uuid not null references lists(list_id) on delete cascade,

  item_id           uuid references item_catalog(item_id),
  custom_name       text,

  quantity          numeric(12, 3) not null default 1,
  unit              text,

  is_checked        boolean not null default false,
  added_by_user     uuid references users(user_id),
  created_at        timestamptz not null default now(),

  check (
    (item_id is not null and custom_name is null)
    or
    (item_id is null and custom_name is not null)
  )
);

-- =========================
-- Indexes
-- =========================
create index if not exists idx_group_members_user on group_members(user_id);
create index if not exists idx_pantries_group on pantries(group_id);
create index if not exists idx_locations_pantry on pantry_locations(pantry_id);
create index if not exists idx_inventory_pantry on inventory_items(pantry_id);
create index if not exists idx_inventory_location on inventory_items(location_id);
create index if not exists idx_inventory_item on inventory_items(item_id);
create index if not exists idx_categories_group on item_categories(group_id);
create index if not exists idx_tags_group on item_tags(group_id);
create index if not exists idx_item_catalog_tags_tag on item_catalog_tags(tag_id);
create index if not exists idx_lists_group on lists(group_id);
create index if not exists idx_list_items_list on list_items(list_id);

-- =========================
-- updated_at trigger for inventory_items
-- =========================
create or replace function set_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_inventory_items_updated_at on inventory_items;
create trigger trg_inventory_items_updated_at
before update on inventory_items
for each row
execute function set_updated_at();


-- =========================
-- Seed data
-- =========================
with
u as (
  insert into users (email, password_hash, display_name)
  values
    ('zach@example.com', '$2b$10$exampleexampleexampleexampleexampleexampleexampleex', 'Zach'),
    ('alex@example.com', '$2b$10$exampleexampleexampleexampleexampleexampleexampleex', 'Alex')
  returning user_id, email, display_name
),
g as (
  insert into groups (name, created_by_user)
  select 'Sutherland Household', (select user_id from u where email='zach@example.com')
  returning group_id, name, created_by_user
),
gm as (
  insert into group_members (group_id, user_id, role)
  values
    ((select group_id from g), (select user_id from u where email='zach@example.com'), 'owner'),
    ((select group_id from g), (select user_id from u where email='alex@example.com'), 'member')
  returning group_id, user_id
),
p as (
  insert into pantries (group_id, name)
  values
    ((select group_id from g), 'Kitchen Pantry'),
    ((select group_id from g), 'Garage Shelf')
  returning pantry_id, name
),
loc as (
  insert into pantry_locations (pantry_id, name, notes, created_by_user)
  values
    ((select pantry_id from p where name='Kitchen Pantry'), 'Cupboard A', 'Top shelf', (select user_id from u where email='zach@example.com')),
    ((select pantry_id from p where name='Kitchen Pantry'), 'Fridge Door', 'Condiments', (select user_id from u where email='zach@example.com')),
    ((select pantry_id from p where name='Garage Shelf'), 'Garage Bin 2', 'Bulk storage', (select user_id from u where email='alex@example.com'))
  returning location_id, pantry_id, name
),
cat as (
  insert into item_categories (group_id, name, created_by_user)
  values
    ((select group_id from g), 'Bakery', (select user_id from u where email='zach@example.com')),
    ((select group_id from g), 'Canned', (select user_id from u where email='zach@example.com')),
    ((select group_id from g), 'Dairy',  (select user_id from u where email='alex@example.com'))
  returning category_id, name
),
items as (
  insert into item_catalog (name, brand, description, default_unit, barcode, category_id)
  values
    ('Bread', 'Stop & Shop', 'Sliced sandwich bread', 'loaf', null, (select category_id from cat where name='Bakery')),
    ('Milk', 'Hood', '2% milk', 'gallon', null, (select category_id from cat where name='Dairy')),
    ('Black Beans', 'Goya', 'Canned black beans', 'can', null, (select category_id from cat where name='Canned'))
  returning item_id, name
),
tags as (
  insert into item_tags (group_id, name, created_by_user)
  values
    ((select group_id from g), 'Bulk', (select user_id from u where email='alex@example.com')),
    ((select group_id from g), 'Emergency', (select user_id from u where email='zach@example.com')),
    ((select group_id from g), 'Kids', (select user_id from u where email='zach@example.com'))
  returning tag_id, name
),
itemtag as (
  insert into item_catalog_tags (item_id, tag_id)
  values
    ((select item_id from items where name='Black Beans'), (select tag_id from tags where name='Bulk')),
    ((select item_id from items where name='Black Beans'), (select tag_id from tags where name='Emergency')),
    ((select item_id from items where name='Milk'), (select tag_id from tags where name='Kids'))
  returning item_id, tag_id
),
inv as (
  insert into inventory_items (
    pantry_id, location_id, item_id, custom_name, quantity, unit, expires_on, notes, created_by_user
  )
  values
    (
      (select pantry_id from p where name='Kitchen Pantry'),
      (select location_id from loc where name='Cupboard A'),
      (select item_id from items where name='Bread'),
      null,
      2, 'loaf',
      null,
      'Use for lunches',
      (select user_id from u where email='zach@example.com')
    ),
    (
      (select pantry_id from p where name='Kitchen Pantry'),
      (select location_id from loc where name='Fridge Door'),
      (select item_id from items where name='Milk'),
      null,
      1, 'gallon',
      current_date + 7,
      'Opened yesterday',
      (select user_id from u where email='alex@example.com')
    ),
    (
      (select pantry_id from p where name='Garage Shelf'),
      (select location_id from loc where name='Garage Bin 2'),
      (select item_id from items where name='Black Beans'),
      null,
      12, 'can',
      current_date + 365,
      'Backstock',
      (select user_id from u where email='alex@example.com')
    ),
    (
      (select pantry_id from p where name='Kitchen Pantry'),
      (select location_id from loc where name='Cupboard A'),
      null,
      'Soy Sauce',
      1, 'bottle',
      null,
      'Custom item example',
      (select user_id from u where email='zach@example.com')
    )
  returning inventory_id
),
l as (
  insert into lists (group_id, name, list_type, created_by_user)
  values ((select group_id from g), 'Weekly Shopping', 'shopping', (select user_id from u where email='zach@example.com'))
  returning list_id
)
insert into list_items (list_id, item_id, custom_name, quantity, unit, is_checked, added_by_user)
values
  ((select list_id from l), (select item_id from items where name='Milk'), null, 1, 'gallon', false, (select user_id from u where email='zach@example.com')),
  ((select list_id from l), null, 'Pickles', 1, 'jar', false, (select user_id from u where email='alex@example.com'));
