@page "/signup"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using Supabase.Gotrue.Exceptions
@layout LoginLayout
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject SupabaseAuthStateProvider supabaseAuth

@attribute [AllowAnonymous]
@rendermode InteractiveServer

<div class="signup-container">
    <div class="signup-shell">
        <div class="welcome-panel">
            <div class="welcome-visual" aria-hidden="true">
                <svg class="welcome-illustration" viewBox="0 0 220 200" role="img">
                    <defs>
                        <linearGradient id="kitGrad" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#a7f3d0" />
                            <stop offset="100%" stop-color="#22c55e" />
                        </linearGradient>
                    </defs>
                    <rect x="10" y="20" width="200" height="140" rx="18" fill="rgba(255,255,255,0.15)" />
                    <rect x="30" y="40" width="160" height="20" rx="10" fill="url(#kitGrad)" />
                    <rect x="30" y="70" width="120" height="16" rx="8" fill="rgba(255,255,255,0.6)" />
                    <rect x="30" y="95" width="140" height="14" rx="7" fill="rgba(255,255,255,0.45)" />
                    <rect x="30" y="118" width="90" height="12" rx="6" fill="rgba(255,255,255,0.35)" />
                    <circle cx="170" cy="115" r="24" fill="url(#kitGrad)" opacity="0.9" />
                </svg>
            </div>
            <h1 class="welcome-title">Create your KITS account</h1>
            <p class="welcome-subtitle">Kitchen Inventory Tracking System</p>
            <p class="welcome-tagline">Set up your family or household inventory in minutes.</p>
        </div>

        <div class="signup-card">
            <div class="signup-header">
                <h2>Create Account</h2>
                <p>Join KITS to start tracking your kitchen inventory</p>
            </div>

            <EditForm EditContext="_editContext" OnSubmit="HandleSubmitAsync" FormName="signup" class="signup-form" novalidate>
                <div class="form-row">
                    <div class="form-group @(HasError(nameof(SignupModel.FirstName)) ? "error" : "")">
                        <div class="input-wrapper">
                            <input id="firstName" name="firstName" type="text" required @bind="_model.FirstName" />
                            <label for="firstName">First Name</label>
                            <span class="focus-border"></span>
                        </div>
                        <span class="error-message @(HasError(nameof(SignupModel.FirstName)) ? "show" : "")">
                            @GetError(nameof(SignupModel.FirstName))
                        </span>
                    </div>

                    <div class="form-group @(HasError(nameof(SignupModel.LastName)) ? "error" : "")">
                        <div class="input-wrapper">
                            <input id="lastName" name="lastName" type="text" required @bind="_model.LastName" />
                            <label for="lastName">Last Name</label>
                            <span class="focus-border"></span>
                        </div>
                        <span class="error-message @(HasError(nameof(SignupModel.LastName)) ? "show" : "")">
                            @GetError(nameof(SignupModel.LastName))
                        </span>
                    </div>
                </div>

                <div class="form-group @(HasError(nameof(SignupModel.Email)) ? "error" : "")">
                    <div class="input-wrapper">
                        <input id="email" name="email" type="email" required autocomplete="email" @bind="_model.Email" />
                        <label for="email">Email Address</label>
                        <span class="focus-border"></span>
                    </div>
                    <span class="error-message @(HasError(nameof(SignupModel.Email)) ? "show" : "")">
                        @GetError(nameof(SignupModel.Email))
                    </span>
                </div>

                <div class="form-group @(HasError(nameof(SignupModel.Password)) ? "error" : "")">
                    <div class="input-wrapper password-wrapper">
                        @if (passwordVisible)
                        {
                            <input id="password" name="password" type="text" required autocomplete="new-password" @bind="_model.Password" @key="passwordVisible" />
                        }
                        else
                        {
                            <input id="password" name="password" type="password" required autocomplete="new-password" @bind="_model.Password" @key="passwordVisible" />
                        }
                        <label for="password">Password</label>
                        <button type="button" class="password-toggle" aria-label="Toggle password visibility" @onclick="TogglePassword" @onclick:preventDefault="true">
                            <span class="eye-icon @(passwordVisible ? "show-password" : "")"></span>
                        </button>
                        <span class="focus-border"></span>
                    </div>
                    <span class="error-message @(HasError(nameof(SignupModel.Password)) ? "show" : "")">
                        @GetError(nameof(SignupModel.Password))
                    </span>
                </div>

                <div class="form-group @(HasError(nameof(SignupModel.ConfirmPassword)) ? "error" : "")">
                    <div class="input-wrapper password-wrapper">
                        @if (confirmVisible)
                        {
                            <input id="confirmPassword" name="confirmPassword" type="text" required autocomplete="new-password" @bind="_model.ConfirmPassword" @key="confirmVisible" />
                        }
                        else
                        {
                            <input id="confirmPassword" name="confirmPassword" type="password" required autocomplete="new-password" @bind="_model.ConfirmPassword" @key="confirmVisible" />
                        }
                        <label for="confirmPassword">Confirm Password</label>
                        <button type="button" class="password-toggle" aria-label="Toggle password visibility" @onclick="ToggleConfirm" @onclick:preventDefault="true">
                            <span class="eye-icon @(confirmVisible ? "show-password" : "")"></span>
                        </button>
                        <span class="focus-border"></span>
                    </div>
                    <span class="error-message @(HasError(nameof(SignupModel.ConfirmPassword)) ? "show" : "")">
                        @GetError(nameof(SignupModel.ConfirmPassword))
                    </span>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <InputFile id="profileImage" class="file-input" accept="image/*" OnChange="HandleImageChanged" />
                        <label class="file-label" for="profileImage">
                            <span class="file-label-text">Optional Profile Image</span>
                            <span class="file-label-subtext">@(selectedImageName ?? "Choose an image")</span>
                        </label>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(imageError))
                    {
                        <span class="error-message show">@imageError</span>
                    }
                </div>

                <button type="submit" class="signup-btn btn @(isSubmitting ? "loading" : "")" disabled="@isSubmitting">
                    <span class="btn-text">Create Account</span>
                    <span class="btn-loader"></span>
                </button>
            </EditForm>

            <div class="signup-link">
                <p>Already have an account? <a href="/login">Sign in</a></p>
            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="form-error">@errorMessage</div>
            }
            @if (!string.IsNullOrWhiteSpace(successMessage))
            {
                <div class="form-success">@successMessage</div>
            }
        </div>
    </div>
</div>

@code {
    private readonly SignupModel _model = new();
    private EditContext _editContext = default!;
    private readonly Dictionary<string, string> _errors = new();
    private bool isSubmitting;
    private string? errorMessage;
    private string? successMessage;
    private bool passwordVisible;
    private bool confirmVisible;
    private IBrowserFile? selectedImage;
    private string? selectedImageName;
    private string? imageError;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private void TogglePassword() => passwordVisible = !passwordVisible;
    private void ToggleConfirm() => confirmVisible = !confirmVisible;

    private void HandleImageChanged(InputFileChangeEventArgs args)
    {
        imageError = null;
        selectedImage = args.File;
        selectedImageName = selectedImage?.Name;

        if (selectedImage is null)
        {
            return;
        }

        if (!selectedImage.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            imageError = "Please choose an image file.";
            selectedImage = null;
            selectedImageName = null;
            return;
        }

        const long maxBytes = 2 * 1024 * 1024;
        if (selectedImage.Size > maxBytes)
        {
            imageError = "Image must be 2MB or smaller.";
            selectedImage = null;
            selectedImageName = null;
        }
    }

    private async Task HandleSubmitAsync(EditContext context)
    {
        if (isSubmitting)
        {
            return;
        }

        _errors.Clear();
        errorMessage = null;
        successMessage = null;

        if (!ValidateModel())
        {
            return;
        }

        if (AuthStateProvider is not SupabaseAuthStateProvider supabaseAuth)
        {
            errorMessage = "Auth provider is not configured.";
            return;
        }

        isSubmitting = true;
        try
        {
            var displayName = $"{_model.FirstName} {_model.LastName}".Trim();

            await supabaseAuth.SignUpAsync(
                _model.Email,
                _model.Password,
                displayName
            );

            successMessage = "Account created. Please check your email to confirm, then sign in.";
        }
        catch (Exception ex)
        {
            @* errorMessage = MapSignupError(ex); *@
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private bool ValidateModel()
    {
        var validationResults = new List<ValidationResult>();
        var isValid = Validator.TryValidateObject(
            _model,
            new ValidationContext(_model),
            validationResults,
            validateAllProperties: true);

        foreach (var result in validationResults)
        {
            var memberName = result.MemberNames.FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(memberName))
            {
                _errors[memberName] = result.ErrorMessage ?? "Invalid value.";
            }
        }

        return isValid;
    }

    private bool HasError(string fieldName) => _errors.ContainsKey(fieldName);
    private string GetError(string fieldName) => _errors.TryGetValue(fieldName, out var msg) ? msg : string.Empty;

    private static string MapSignupError(Exception ex)
    {
        if (ex is GotrueException gte)
        {
            return gte.Reason switch
            {
                FailureHint.Reason.UserAlreadyRegistered =>
                    "An account with that email already exists. Try signing in or resetting your password.",
                FailureHint.Reason.UserBadEmailAddress =>
                    "That email address looks invalid. Try a different email address.",
                FailureHint.Reason.UserTooManyRequests =>
                    "Too many attempts. Please wait a moment and try again.",
                _ =>
                    "We couldn't create your account. Please check your details and try again."
            };
        }

        return "We couldn't create your account. Please check your details and try again.";
    }

    private sealed class SignupModel
    {
        [Required]
        public string FirstName { get; set; } = string.Empty;

        [Required]
        public string LastName { get; set; } = string.Empty;

        [Required, EmailAddress]
        public string Email { get; set; } = string.Empty;

        [Required, MinLength(6)]
        public string Password { get; set; } = string.Empty;

        [Required, Compare(nameof(Password), ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
