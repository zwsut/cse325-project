@page "/inventory/{Location}"
@using cse325_project.Models.Database
@using cse325_project.Services
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@inject ISupabaseService SupabaseService
@inject IUserContextService UserContextService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>@Title</PageTitle>

<div class="location-head">
    <h1>@Title</h1>
    <a class="btn-add" href="/items/new">Add Item</a>
</div>

@if (_loading)
{
    <p>Loading items...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <p class="simple-muted">Error: @_error</p>
}
else
{
    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <div class="form-message">@_message</div>
    }

    <div class="table-wrap">
        <table class="inv-table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Items.Count == 0)
                {
                    <tr>
                        <td colspan="5" class="desc">No items in this location yet.</td>
                    </tr>
                }
                else
                {
                    @foreach (var item in Items)
                    {
                        <tr>
                            <td>@item.Name</td>
                            <td>@item.Amount</td>
                            <td>@item.Category</td>
                            <td class="desc">@item.Description</td>
                            <td class="actions">
                                <button class="icon-btn"
                                        type="button"
                                        title="Add to shopping list"
                                        aria-label="Add to shopping list"
                                        @onclick="() => AddToShoppingListAsync(item)"
                                        disabled="@_busy">ðŸ›’</button>

                                <button class="icon-btn"
                                        type="button"
                                        title="Edit"
                                        aria-label="Edit"
                                        @onclick="() => StartEditAsync(item)"
                                        disabled="@_busy">âœŽ</button>

                                <button class="icon-btn danger"
                                        type="button"
                                        title="Delete"
                                        aria-label="Delete"
                                        @onclick="() => DeleteInventoryItemAsync(item)"
                                        disabled="@_busy">ðŸ—‘</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

@if (_edit is not null)
{
    <div class="overlay" @onclick="CloseEdit"></div>

    <aside class="edit-panel" role="dialog" aria-label="Edit Inventory Item">
        <div class="edit-header">Edit Inventory Item</div>

        <EditForm Model="_edit" OnValidSubmit="SaveEditAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="edit-body">
                <h2 class="edit-title">@_edit.DisplayName</h2>

                <div class="block">
                    <div class="block-title">Inventory</div>

                    <div class="form-row">
                        <label>Quantity</label>
                        <InputNumber class="input" @bind-Value="_edit.Quantity" disabled="@_busy" />
                    </div>

                    <div class="form-row">
                        <label>Unit</label>
                        <InputText class="input" @bind-Value="_edit.Unit" disabled="@_busy" />
                    </div>

                    <div class="form-row">
                        <label>Notes</label>
                        <InputTextArea class="input" rows="4" @bind-Value="_edit.Notes" disabled="@_busy" />
                    </div>
                </div>
            </div>

            <div class="edit-actions">
                <button class="btn-save" type="submit" disabled="@_busy">Save</button>
                <button class="btn-cancel" type="button" @onclick="CloseEdit" disabled="@_busy">Cancel</button>
            </div>
        </EditForm>
    </aside>
}

@code {
    [Parameter] public string? Location { get; set; }

    private string _title = "Inventory";
    private bool _loading = true;
    private bool _busy;
    private string? _error;
    private string? _message;

    private AppUser? _currentUser;
    private Group? _currentGroup;
    private AppList? _shoppingList;

    private List<InventoryDisplayItem> _items = new();
    private EditModel? _edit;

    private string Title => _title;
    private IReadOnlyList<InventoryDisplayItem> Items => _items;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;
        _message = null;
        _items = new();
        _edit = null;

        try
        {
            await SupabaseService.InitializeAsync();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            var email = authState.User.FindFirst(ClaimTypes.Email)?.Value;

            (_currentUser, _currentGroup) = await UserContextService.GetForClaimsAsync(userIdClaim, email);
            if (_currentUser is null || _currentGroup is null)
            {
                _error = "You must be logged in.";
                return;
            }

            _shoppingList = await GetOrCreateShoppingListAsync(_currentGroup.GroupId, _currentUser.UserId);

            // 1) Load pantries for this user's group
            var pantryRes = await SupabaseService.Client
                .From<Pantry>()
                .Where(p => p.GroupId == _currentGroup.GroupId)
                .Get();

            var pantries = pantryRes.Models ?? new List<Pantry>();
            if (pantries.Count == 0)
            {
                _title = "Inventory";
                _items = new();
                return;
            }

            PantryLocation? matchedLocation = null;
            Pantry? matchedPantry = null;

            foreach (var pantry in pantries)
            {
                var locRes = await SupabaseService.Client
                    .From<PantryLocation>()
                    .Where(l => l.PantryId == pantry.PantryId)
                    .Get();

                var locations = locRes.Models ?? new List<PantryLocation>();
                matchedLocation = locations.FirstOrDefault(l => ToSlug(l.Name) == (Location ?? "").ToLowerInvariant());
                if (matchedLocation is not null)
                {
                    matchedPantry = pantry;
                    break;
                }
            }

            if (matchedLocation is null || matchedPantry is null)
            {
                _title = ToTitle(Location);
                _items = new();
                return;
            }

            _title = $"{matchedPantry.Name} / {matchedLocation.Name}";

            // 2) Query inventory items for this location
            var invRes = await SupabaseService.Client
                .From<InventoryItem>()
                .Where(i => i.LocationId == matchedLocation.LocationId)
                .Get();

            var invItems = invRes.Models ?? new List<InventoryItem>();

            // 3) Pull catalog for any item_id we have (so we can show names)
            var itemIds = invItems
                .Where(i => i.ItemId.HasValue)
                .Select(i => i.ItemId!.Value)
                .Distinct()
                .ToList();

            var catalogMap = new Dictionary<Guid, CatalogItem>();
            if (itemIds.Count > 0)
            {
                var catRes = await SupabaseService.Client.From<CatalogItem>().Get();
                var cat = catRes.Models ?? new List<CatalogItem>();
                catalogMap = cat.Where(c => itemIds.Contains(c.ItemId))
                                .ToDictionary(c => c.ItemId, c => c);
            }

            // 4) Map to display model
            _items = invItems
                .OrderBy(i => i.CreatedAt)
                .Select(i =>
                {
                    var name =
                        i.CustomName ??
                        (i.ItemId.HasValue && catalogMap.TryGetValue(i.ItemId.Value, out var c)
                            ? (string.IsNullOrWhiteSpace(c.Brand) ? c.Name : $"{c.Name} ({c.Brand})")
                            : "Unnamed");

                    var amount = $"{i.Quantity} {i.Unit}".Trim();

                    return new InventoryDisplayItem(
                        i.InventoryId,
                        i.ItemId,
                        i.CustomName,
                        i.Unit,
                        name,
                        amount,
                        "", // category later
                        i.Notes ?? ""
                    );
                })
                .ToList();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task StartEditAsync(InventoryDisplayItem item)
    {
        if (_busy) return;
        _busy = true;
        _message = null;

        try
        {
            var res = await SupabaseService.Client
                .From<InventoryItem>()
                .Where(i => i.InventoryId == item.InventoryId)
                .Get();

            var db = res.Models?.FirstOrDefault();
            if (db is null)
            {
                _message = "Item not found.";
                return;
            }

            _edit = new EditModel
            {
                InventoryId = db.InventoryId,
                DisplayName = item.Name,
                Quantity = db.Quantity,
                Unit = db.Unit,
                Notes = db.Notes
            };
        }
        catch (Exception ex)
        {
            _message = $"Error loading item: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private void CloseEdit() => _edit = null;

    private async Task SaveEditAsync()
    {
        if (_busy || _edit is null) return;
        _busy = true;
        _message = null;

        try
        {
            var qty = _edit.Quantity <= 0 ? 1 : _edit.Quantity;
            var unit = string.IsNullOrWhiteSpace(_edit.Unit) ? null : _edit.Unit.Trim();
            var notes = string.IsNullOrWhiteSpace(_edit.Notes) ? null : _edit.Notes.Trim();

            var res = await SupabaseService.Client
                .From<InventoryItem>()
                .Where(i => i.InventoryId == _edit.InventoryId)
                .Get();

            var db = res.Models?.FirstOrDefault();
            if (db is null)
            {
                _message = "Item not found.";
                return;
            }

            db.Quantity = qty;
            db.Unit = unit;
            db.Notes = notes;
            db.UpdatedAt = DateTime.UtcNow;

            await SupabaseService.Client.From<InventoryItem>().Update(db);

            // Update UI row immediately
            var idx = _items.FindIndex(x => x.InventoryId == _edit.InventoryId);
            if (idx >= 0)
            {
                var old = _items[idx];
                _items[idx] = old with
                {
                    Unit = unit,
                    Amount = $"{qty} {unit}".Trim(),
                    Description = notes ?? ""
                };
            }

            _message = "Saved.";
            _edit = null;
        }
        catch (Exception ex)
        {
            _message = $"Error saving: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task AddToShoppingListAsync(InventoryDisplayItem inv)
    {
        if (_busy || _currentUser is null || _currentGroup is null) return;
        _busy = true;
        _message = null;

        try
        {
            _shoppingList ??= await GetOrCreateShoppingListAsync(_currentGroup.GroupId, _currentUser.UserId);

            var itemId = inv.ItemId;
            var customName = itemId is null ? (inv.CustomName ?? inv.Name).Trim() : null;

            if (itemId is null && string.IsNullOrWhiteSpace(customName))
            {
                _message = "Can't add: item has no name.";
                return;
            }

            var unit = string.IsNullOrWhiteSpace(inv.Unit) ? null : inv.Unit.Trim();

            await SupabaseService.Client
                .From<AppListItem>()
                .Insert(new AppListItem
                {
                    ListItemId = Guid.NewGuid(),
                    ListId = _shoppingList!.ListId,
                    ItemId = itemId,
                    CustomName = customName,
                    Quantity = 1,
                    Unit = unit,
                    IsChecked = false,
                    AddedByUser = _currentUser.UserId,
                    CreatedAt = DateTime.UtcNow
                });

            _message = "Added to shopping list.";
        }
        catch (Exception ex)
        {
            _message = $"Error adding to shopping list: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task DeleteInventoryItemAsync(InventoryDisplayItem inv)
    {
        if (_busy) return;
        _busy = true;
        _message = null;

        try
        {
            await SupabaseService.Client
                .From<InventoryItem>()
                .Where(i => i.InventoryId == inv.InventoryId)
                .Delete();

            _items.RemoveAll(x => x.InventoryId == inv.InventoryId);

            // If the edited item was deleted, close panel
            if (_edit is not null && _edit.InventoryId == inv.InventoryId)
                _edit = null;

            _message = "Deleted.";
        }
        catch (Exception ex)
        {
            _message = $"Error deleting item: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task<AppList> GetOrCreateShoppingListAsync(Guid groupId, Guid userId)
    {
        var res = await SupabaseService.Client
            .From<AppList>()
            .Where(l => l.GroupId == groupId)
            .Get();

        var existing = (res.Models ?? new List<AppList>())
            .FirstOrDefault(l => string.Equals(l.ListType, "shopping", StringComparison.OrdinalIgnoreCase)
                              && l.ArchivedAt == null);

        if (existing is not null) return existing;

        var inserted = await SupabaseService.Client
            .From<AppList>()
            .Insert(new AppList
            {
                ListId = Guid.NewGuid(),
                GroupId = groupId,
                Name = "Shopping List",
                ListType = "shopping",
                CreatedByUser = userId,
                CreatedAt = DateTime.UtcNow,
                ArchivedAt = null
            });

        return inserted.Models.First();
    }

    private static string ToTitle(string? location)
    {
        if (string.IsNullOrWhiteSpace(location)) return "Inventory";
        return location
            .Replace('-', ' ')
            .Split(' ', StringSplitOptions.RemoveEmptyEntries)
            .Select(w => char.ToUpperInvariant(w[0]) + w[1..])
            .Aggregate((a, b) => $"{a} {b}");
    }

    private static string ToSlug(string? value)
    {
        if (string.IsNullOrWhiteSpace(value)) return "inventory";

        var chars = value.Trim().ToLowerInvariant()
            .Select(c => char.IsLetterOrDigit(c) ? c : '-')
            .ToArray();

        var normalized = new string(chars);
        while (normalized.Contains("--"))
            normalized = normalized.Replace("--", "-");

        var slug = normalized.Trim('-');
        return string.IsNullOrWhiteSpace(slug) ? "inventory" : slug;
    }

    private sealed record InventoryDisplayItem(
        Guid InventoryId,
        Guid? ItemId,
        string? CustomName,
        string? Unit,
        string Name,
        string Amount,
        string Category,
        string Description
    );

    private sealed class EditModel
    {
        public Guid InventoryId { get; set; }
        public string DisplayName { get; set; } = "";

        [Range(0.0001, 999999, ErrorMessage = "Quantity must be greater than 0.")]
        public decimal Quantity { get; set; } = 1;

        public string? Unit { get; set; }
        public string? Notes { get; set; }
    }
}
