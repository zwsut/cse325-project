@page "/inventory/edit"
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using cse325_project.Services
@inject ISupabaseService SupabaseService
@inject IUserContextService UserContextService
@inject IAppDataChangeService AppDataChangeService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Edit Inventory</PageTitle>
<h1 class="simple-title">Edit Inventory Location</h1>
<p class="simple-muted">Create and manage pantry locations for your household.</p>

@if (_isLoading)
{
    <p>Loading locations...</p>
}
else
{
    <div class="form-wrap">
        <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-row">
                <label>Location</label>
                <InputSelect @bind-Value="_selectedPantryId" class="input">
                    <option value="">Select location...</option>
                    @foreach (var pantry in _pantries)
                    {
                        <option value="@pantry.PantryId.ToString()">@pantry.Name</option>
                    }
                    <option value="@CreateNewPantryOption">+ Create new location</option>
                </InputSelect>
                @if (!string.IsNullOrWhiteSpace(_pantryValidationMessage))
                {
                    <div class="validation-message">@_pantryValidationMessage</div>
                }
            </div>

            @if (_selectedPantryId == CreateNewPantryOption)
            {
                <div class="form-row">
                    <label>New Location Name</label>
                    <InputText @bind-Value="_newPantryName" class="input" />
                </div>

                <div class="form-actions">
                    <button class="btn-cancel" type="button" @onclick="CreateLocationOnlyAsync" disabled="@_isBusy">Create Location</button>
                </div>
            }

            <div class="form-row">
                <label>Container</label>
                <InputText @bind-Value="Model.SubLocation" class="input" />
                <ValidationMessage For="() => Model.SubLocation" />
            </div>

            <div class="form-row">
                <label>Description / Notes</label>
                <InputTextArea @bind-Value="Model.Description" class="input" />
                <ValidationMessage For="() => Model.Description" />
            </div>

            <div class="form-actions">
                <button class="btn-save" type="submit" disabled="@_isBusy">@(_editingLocationId is null ? "Add Location" : "Save Changes")</button>
                <button class="btn-cancel" type="button" @onclick="CancelEdit" disabled="@_isBusy">Cancel</button>
            </div>
        </EditForm>

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="form-message">@Message</div>
        }
    </div>

    <h2>Current locations</h2>
    @if (_pantries.Count == 0)
    {
        <table class="locations-table">
            <thead>
                <tr>
                    <th>Container</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3" class="empty-row">No locations created yet.</td>
                </tr>
            </tbody>
        </table>
    }
    else
    {
        @foreach (var pantry in _pantries)
        {
            var pantryLocations = Locations
                .Where(location => location.PantryId == pantry.PantryId)
                .OrderBy(location => location.LocationName)
                .ToList();

            <h3 class="location-group-title">Location: @pantry.Name</h3>
            <table class="locations-table">
                <thead>
                    <tr>
                        <th>Container</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (pantryLocations.Count == 0)
                    {
                        <tr>
                            <td colspan="3" class="empty-row">No containers added yet.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var location in pantryLocations)
                        {
                            <tr>
                                <td>@location.LocationName</td>
                                <td>@location.Notes</td>
                                <td>
                                    <button class="btn-link" type="button" @onclick="() => SelectForEdit(location)" disabled="@_isBusy">Edit</button>
                                    <button class="btn-link-danger" type="button" @onclick="() => DeleteRow(location)" disabled="@_isBusy">Delete</button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    }
}

@if (Locations.Any())
{
    <h2>Current locations</h2>
    <table class="locations-table">
        <thead>
            <tr>
                <th>Main</th>
                <th>Sub</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var loc in Locations)
            {
                <tr>
                    <td>@loc.MainLocation</td>
                    <td>@loc.SubLocation</td>
                    <td>@loc.Description</td>
                    <td>
                        <button class="btn-link" @onclick="() => SelectForEdit(loc)">Edit</button>
                        <button class="btn-link-danger" @onclick="() => DeleteRow(loc)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private InventoryEditLocationFormModel Model { get; set; } = new();
    private string? Message;
    private bool _isLoading = true;
    private bool _isBusy;

    private AppUser? _currentUser;
    private Group? _currentGroup;
    private Guid? _editingLocationId;
    private string _selectedPantryId = string.Empty;
    private string _newPantryName = string.Empty;
    private string? _pantryValidationMessage;
    private List<Pantry> _pantries = new();
    private List<InventoryEditLocationRow> Locations = new();

    private const string CreateNewPantryOption = "__create_new_pantry__";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await SupabaseService.InitializeAsync();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            var emailClaim = authState.User.FindFirst(ClaimTypes.Email)?.Value;

            (_currentUser, _currentGroup) = await UserContextService.GetForClaimsAsync(userIdClaim, emailClaim);
            await RefreshLocations();
        }
        catch (Exception ex)
        {
            Message = $"Error loading locations: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task RefreshLocations()
    {
        if (_currentGroup is null)
        {
            Locations = new();
            _pantries = new();
            return;
        }

        var pantryResponse = await SupabaseService.Client
            .From<Pantry>()
            .Where(p => p.GroupId == _currentGroup.GroupId)
            .Get();

        _pantries = (pantryResponse.Models ?? new List<Pantry>())
            .OrderBy(p => p.Name)
            .ToList();

        if (_editingLocationId is null)
        {
            if (_pantries.Count == 0)
            {
                _selectedPantryId = CreateNewPantryOption;
            }
            else if (!Guid.TryParse(_selectedPantryId, out var selectedPantryId) ||
                     _pantries.All(p => p.PantryId != selectedPantryId))
            {
                _selectedPantryId = _pantries[0].PantryId.ToString();
            }
        }

        var rows = new List<InventoryEditLocationRow>();
        foreach (var pantry in _pantries)
        {
            var locationResponse = await SupabaseService.Client
                .From<PantryLocation>()
                .Where(l => l.PantryId == pantry.PantryId)
                .Get();

            var mapped = (locationResponse.Models ?? new List<PantryLocation>())
                .OrderBy(l => l.Name)
                .Select(l => new InventoryEditLocationRow(
                    l.LocationId,
                    pantry.PantryId,
                    pantry.Name ?? "Unnamed Pantry",
                    l.Name ?? "Unnamed Location",
                    l.Notes));

            rows.AddRange(mapped);
        }

        Locations = rows
            .OrderBy(r => r.PantryName)
            .ThenBy(r => r.LocationName)
            .ToList();
    }

    private async Task HandleValidSubmit()
    {
        if (_currentGroup is null || _currentUser is null || _isBusy)
        {
            return;
        }

        _isBusy = true;
        Message = null;
        _pantryValidationMessage = null;

        try
        {
            var pantry = await ResolveSelectedPantryAsync();
            if (pantry is null)
            {
                return;
            }

            var locationName = Model.SubLocation?.Trim() ?? string.Empty;
            var notes = string.IsNullOrWhiteSpace(Model.Description) ? null : Model.Description.Trim();

            if (_editingLocationId is null)
            {
                await SupabaseService.Client
                    .From<PantryLocation>()
                    .Insert(new PantryLocation
                    {
                        LocationId = Guid.NewGuid(),
                        PantryId = pantry.PantryId,
                        Name = locationName,
                        Notes = notes,
                        CreatedByUser = _currentUser.UserId,
                        CreatedAt = DateTime.UtcNow
                    });

                Message = "Location added.";
                AppDataChangeService.NotifyChanged(AppDataScopes.Locations);
            }
            else
            {
                await SupabaseService.Client
                    .From<PantryLocation>()
                    .Where(l => l.LocationId == _editingLocationId.Value)
                    .Set(l => l.PantryId, pantry.PantryId)
                    .Set(l => l.Name!, locationName)
                    .Set(l => l.Notes!, notes)
                    .Update();

                Message = "Location updated.";
                AppDataChangeService.NotifyChanged(AppDataScopes.Locations);
            }

            ResetForm();
            await RefreshLocations();
        }
        catch (Exception ex)
        {
            Message = $"Error saving location: {ex.Message}";
        }
        finally
        {
            _isBusy = false;
        }
    }

    private async Task<Pantry?> ResolveSelectedPantryAsync()
    {
        if (_selectedPantryId == CreateNewPantryOption)
        {
            var newPantryName = _newPantryName.Trim();
            if (string.IsNullOrWhiteSpace(newPantryName))
            {
                _pantryValidationMessage = "Enter a location name.";
                return null;
            }

            return await FindOrCreatePantryAsync(newPantryName);
        }

        if (!Guid.TryParse(_selectedPantryId, out var pantryId))
        {
            _pantryValidationMessage = "Select a location or create a new one.";
            return null;
        }

        var selected = _pantries.FirstOrDefault(p => p.PantryId == pantryId);
        if (selected is null)
        {
            _pantryValidationMessage = "Selected location was not found. Refresh and try again.";
            return null;
        }

        return selected;
    }

    private async Task CreateLocationOnlyAsync()
    {
        if (_currentGroup is null || _isBusy)
        {
            return;
        }

        _isBusy = true;
        Message = null;
        _pantryValidationMessage = null;

        try
        {
            var locationName = _newPantryName.Trim();
            if (string.IsNullOrWhiteSpace(locationName))
            {
                _pantryValidationMessage = "Enter a location name.";
                return;
            }

            var existing = _pantries.FirstOrDefault(p =>
                string.Equals(p.Name?.Trim(), locationName, StringComparison.OrdinalIgnoreCase));

            if (existing is not null)
            {
                _selectedPantryId = existing.PantryId.ToString();
                _newPantryName = string.Empty;
                Message = "Location already exists and is now selected.";
                return;
            }

            var created = await FindOrCreatePantryAsync(locationName);
            _selectedPantryId = created.PantryId.ToString();
            _newPantryName = string.Empty;
            Message = "Location created. You can now add containers.";
            await RefreshLocations();
            AppDataChangeService.NotifyChanged(AppDataScopes.Locations);
        }
        catch (Exception ex)
        {
            Message = $"Error creating location: {ex.Message}";
        }
        finally
        {
            _isBusy = false;
        }
    }

    private async Task<Pantry> FindOrCreatePantryAsync(string pantryName)
    {
        var existing = _pantries.FirstOrDefault(p =>
            string.Equals(p.Name?.Trim(), pantryName, StringComparison.OrdinalIgnoreCase));

        if (existing is not null)
        {
            return existing;
        }

        var pantry = new Pantry
        {
            PantryId = Guid.NewGuid(),
            GroupId = _currentGroup!.GroupId,
            Name = pantryName,
            CreatedAt = DateTime.UtcNow
        };

        await SupabaseService.Client
            .From<Pantry>()
            .Insert(pantry);

        _pantries.Add(pantry);
        return pantry;
    }

    private void CancelEdit()
    {
        Message = null;
        _pantryValidationMessage = null;
        ResetForm();
    }

    private void SelectForEdit(InventoryEditLocationRow row)
    {
        _editingLocationId = row.LocationId;
        _selectedPantryId = row.PantryId.ToString();
        _newPantryName = string.Empty;
        _pantryValidationMessage = null;
        Model = new InventoryEditLocationFormModel
        {
            SubLocation = row.LocationName,
            Description = row.Notes
        };
        Message = null;
    }

    private async Task DeleteRow(InventoryEditLocationRow row)
    {
        if (_isBusy)
        {
            return;
        }

        _isBusy = true;
        Message = null;

        try
        {
            await SupabaseService.Client
                .From<PantryLocation>()
                .Where(l => l.LocationId == row.LocationId)
                .Delete();

            if (_editingLocationId == row.LocationId)
            {
                ResetForm();
            }

            await RefreshLocations();
            Message = "Location deleted.";
            AppDataChangeService.NotifyChanged(AppDataScopes.Locations);
        }
        catch (Exception ex)
        {
            Message = $"Error deleting location: {ex.Message}";
        }
        finally
        {
            _isBusy = false;
        }
    }

    private void ResetForm()
    {
        _editingLocationId = null;
        _newPantryName = string.Empty;
        _pantryValidationMessage = null;

        if (_pantries.Count == 0)
        {
            _selectedPantryId = CreateNewPantryOption;
        }
        else
        {
            _selectedPantryId = _pantries[0].PantryId.ToString();
        }

        Model = new InventoryEditLocationFormModel();
    }
}
